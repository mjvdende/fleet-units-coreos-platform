[Unit]
Description=Marathon
After=docker.service
After=etcd.service
After=fleet.service
After=consul-server.service
After=mesos-master.service
After=mesos-slave.service
After=zookeeper.service

[Service]
Restart=always
TimeoutStartSec=300
RestartSec=10

EnvironmentFile=/etc/environment
Environment="REPOSITORY=mesosphere/marathon:v0.10.0"
ExecStartPre=-/usr/bin/docker kill x-%p
ExecStartPre=-/usr/bin/docker rm x-%p
ExecStartPre=/usr/bin/docker pull ${REPOSITORY}
# Test whether the zookeeper is up.
ExecStartPre=/bin/sh -c "curl -s $COREOS_PRIVATE_IPV4:8500/v1/catalog/service/zookeeper?tag=zk | jq -r -e .[0].ServiceAddress"

ExecStart=/bin/bash -c "ZOOKEEPERS=$(curl $COREOS_PRIVATE_IPV4:8500/v1/catalog/service/zookeeper?tag=zk | \
        jq -r '.[0] | (\"zk://\" + .ServiceAddress + \":\" + (.ServicePort | tostring))') ;\
    exec /usr/bin/docker run \
    --name x-%p \
    --net host \
    -p $COREOS_PRIVATE_IPV4:8888:8888 \
    -e SERVICE_NAME=marathon \
    -e SERVICE_TAGS=http \
    ${REPOSITORY}  \
    --master $ZOOKEEPERS/mesos \
    --zk $ZOOKEEPERS/marathon \
    --http_port 8888"

ExecStop=/usr/bin/docker stop x-%p
SyslogIdentifier=%p
